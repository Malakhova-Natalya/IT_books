# Ralph Kimball, Margy Ross "The Data Warehouse Toolkit. The Definitive Guide to Dimensional Modeling" (Third Edition)
## Introduction & Chapter 1
## Data Warehousing, Business Intelligence, and Dimensional Modeling Primer

### Вступление, основы

Конспектирую краткое содержание:

Авторы "собаку съели" в области моделирования данных. Они работали десятки лет в области, видели кучу кейсов, их методология выдержала испытание временем.

Проходимся по основным тезисам и понятиям, чтобы при чтении книги быть "на одной волне".

В центре – бизнес-пользователи. Аналогия: издатель модных журналов и менеджер DW/BI. Издатель журналов не печатает журнал, чтобы он ему понравился. Он создаёт такой журнал, который понравится другим: его аудитории, которая заинтересуется, купит его,  и придёт ещё. Поэтому при создании DW/BI смотрим не на технологии, не на "правильность", а на потребности будущих пользователей.

Поэтому одна из важных черт моделирования данных по Кимбаллу – простота и интуитивная понятность/очевидность. Для бизнес-пользователя всё должно быть просто и легко. Данные должны быть легко доступны, заполнены, представлены во времени, система должна адаптироваться под изменения, должна быть защищённой. Но главное по Кимбаллу можно сформулировать так: "Хранилище данных должно быть хорошей, достоверной, надёжной основой для принятия бизнес-решений. Хорошо то Хранилище, которым пользуются". 

Добавим красочности: по Кимбаллу менеджер DW/BI должен быть одной ногой в бизнесе (понимает, кому и для чего нужно Хранилище), другой ногой в технологиях (строит Хранилище). И вот, у него как будто две разъезжающихся ноги, и он отчаянно их сводит вместе.

Dimensional Modeling

Оно служит двум главным целям:
- понятные данные 
- быстрые запросы

Простота – залог успеха. Никаких приведений к третьей нормальной форме – в таких подходах образуется множество отдельных бизнес-сущностей, которые разрастаются в целую сеть нормализованных таблиц с их взаимосвязями, и таблиц этих и связей могут быть сотни. Эта система может быть слишком усложненной для бизнес-пользователей. Поэтому взаимосвязи между таблицами Кимбалл говорит – да, гонке за нормализацией – нет.

### Схема звезда
Основа подхода – схема звезда. В центре – таблица фактов (например, продажи). По краям – таблицы измерений (например, рынок, продукт, время). Таблицы фактов и измерений – это ключевые компоненты.

Таблица фактов должна иметь одинаковую гранулярность для событий – например, одна строка – одна продажа. Записываем кол-во денег и кол-во товара. Остальное – название товара, данные продавца и покупателя – это всё ключи для связанных таблиц-измерений, туда выводится вся эта информация.

Таким образом: 

- таблица фактов в центре, таблицы измерений – по краям

- таблица фактов содержит цифры, таблицы измерений – текст

- таблица фактов узкая и сколько угодно длинная, таблицы измерений – широкие и короткие

- (другими словами таблица фактов имеет сколько угодно строк, таблицы измерений – столбцов)

- таблица фактов состоит только из реальных данных, показывать отсутствие продаж строками с нулями не нужно

- таблицы фактов бывают трёх видов гранулярности: транзакционного, периодического снимка данных, накопительного снимка данных

- все фактические таблицы имеют от двух внешних ключей

- каждый внешний ключ таблицы фактов является первичным ключом связанной таблицы измерений

- таблица фактов, как правило, имеет свой собственный первичный ключ, составленный из ряда внешних ключей (составной ключ)

- таблицы фактов имеют связь многие-ко-многим 

**Понятия:**
- внешний ключ – `FK – foreign key`

- первичный ключ – `PK – primary key`

- составной ключ – `composite key`

Из неочевидного: 
- в таблицах измерений предпочтителен текст. Всегда. Даже если у вас есть сложившаяся система кодов, Кимбалл предлагает добавлять и текстовую расшифровку тоже. Суть: помним – в центре простота и интуитивная понятность.

- по Кимбаллу при повторяющихся значениях в таблице измерений не стоит поддаваться соблазну и выводить повторяющиеся данные в отдельную таблицу (например, для товара выводить в отдельные таблицы бренд, категорию). Таким образом мы получим схему "снежинка", что по Кимбаллу не ок. Его аргументы: в сравнении с таблицей фактов места вы выиграете немного (таблица измерений и так не большая). А от идеи простоты и интуитивной понятности отойдёте. Так что широкая таблица измерений с кучей повторяющегося текста – по Кимбаллу это ок, это для благой цели.

- вопреки "фольклору", Кимбалл не придумал термины "таблица фактов", "таблица измерений". Насколько удалось установить, эта терминология произошла из совместного исследования General Mills и Dartmouth University в 1960-х. Далее в 70-х её использовали AC Nielsen и IRI. Вобщем, можно сказать, что нет одной единственной персоны, кто взял и придумал эти термины, как и сам этот подход. Жизнь заставила людей выводить данные так, следуя логике простоты и производительности, намекает автор

### Соединение таблиц в схеме звезда 

Простота и симметричность – вот первое впечатление от соединения таблиц. Бизнес-пользователи выигрывают от этого: легко понять,легко ориентироваться, снижен риск ошибок и недопониманий.

Кроме этого, выигрывает производительность: меньше таблиц – меньше джойнов.

Атомарные, не агрегированные данные – самые выразительные. Это основа для всех таблиц фактов. Они выдержат любые ад-хоки и неожиданные вопросы от пользователей.

Дополнительно автор подмечает, что любые изменения можно добавить и в таблицы измерений, и в таблицы фактов (соблюдая имеющуюся гранулярность).

Дополняющая природа таблиц фактов и таблиц измерений хорошо видна при сборе отчёта. Из таблиц измерений мы берём данные для фильтрации (where) и агрегации (group by), из таблиц фактов берём цифры (sum). Другими словами, из таблиц измерений мы берём слова – район, бренд, любые другие лейблы, из таблицы фактов – числовые значения.

### Компоненты архитектуры по Кимбаллу

**Операционные данные**

Системы, работающие с потоком транзакций. Здесь своя специфика – эти системы не предназначены для анализа, здесь нет истории, это именно транзакции одна за одной. Здесь важны производительность, доступность. 

**ETL**

В идеале нигде не надо третьей нормальной формы

**Presentation area**

Критически важно иметь данные с максимально возможной гранулярностью. У пользователя должна быть возможность делать drill-down исследование вплоть до отдельных строк. Запросы пользователей могут быть непредсказуемыми. Ответом могут быть только сами детальные данные, без агрегаций.

Важно иметь единую таблицу фактов. Не надо строить и поддерживать отдельные таблицы фактов для разных департаментов, где идёт похожий, но немного отличающийся расчёт/обработка данных. Важно, чтобы таблица фактов проходила сквозь границы разных подразделений компании, и департаменты не имели индивидуальных интерпретаций.

Ресторан как метафора архитектуры по Кимбаллу

ETL – кухня

Ингредиенты, обработка, качество, стандарты, производительность

Кухня в ресторане – отдельный мир. Сюда не заходят клиенты, не суют палец в соус, пробуя его на вкус. Здесь острые ножи, открытое пламя, и даже если кухня (частично) показана клиенту, она за стеклом – ведь вход сюда посторонним запрещён.

Зал в ресторане – а вот это место для гостей. Еда (данные), декор (удобство), сервис, цена – вот критерии, по которым оценивают ресторан (читай: DW/BI систему).

### Альтернативные подходы

**Independent Data Mart Architecture**

Разные отделы/команды строят свои витрины независимо друг друга. Зачастую из одних и тех же сырых данных данных, но немного с разными расчётами/фильтрами/преобразованиями. Неудивительно, что при сравнении цифр – ничего толком не совпадает. К тому же, одни и те же источники сырых данных по несколько раз участвуют в построении отчётов (конкуренция за ресурсы, большая нагрузка на пайплайны).

Хотя никто из лидеров индустрии не отстаивает этот подход, он является доминирующим во многих компаниях, особенно больших. Так происходит из-за отсутствия налаженных процессов координации между командами.

Этот подход очень соблазнителен на короткой дистанции – строишь нужный отчёт и выводишь в прод. Никаких преград. Зато на долгой дистанции вся компания начинает испытывать проблемы – куча запросов в сырые источники, разные цифры в отчётах... а если однажды всё упрётся в лимиты производительности, всё это ещё начнёт падать, и даже эти разношёрстные цифры вовремя будет не получить.

**Corporate Information Factory**

Подход Билла Инмона – в отличие от похода Кимбаллу, третья нормальная форма – обязательный компонент. По Инмону 3NF решает вопрос интегрированности данных. По Кимбаллу – нет, 3NF необязательна, можно решить проблему через согласованные измерения. Также отличием является то, что по Инмону максимально гранулированные данные находятся в среднем слое, а в data marts идут зачастую уже агрегированные данные, для разных отделов – свои. По Кимбаллу максимальная гранулярность (atomic details) идёт в сам data mart (если я правильно понимаю, агрегация идёт уже на уровне дашборда, и если нужно, можно в BI системе распустить эту агрегацию и дойти до отдельных интересующих случаев, не переходя в другие слои – все atomic details есть в data mart).

Кимбалл видит возможную опасность подхода Инмона в сложной для запросов нормализованной структуре, отправляющей в разные отделы разные (не совсем бьющиеся между собой) отчёты.

**Hybrid**

Этот поход "женит" подходы Инмона и Кимбалла. В "back room" условного DW-ресторана нормализованный подход Инмона, в "front room" – Dimensional presentation area. Автор рекомендует этот подход, если ваша организация уже вложилась в создание 3NF EDW (Enterprise Data Warehouse) по Инмону, но отчёты недостаточно быстры и гибки. Если же вы начинаете с чистого листа, то подход займёт довольно много времени и денег.

### Мифы о многомерном моделировании (Dimensional Modeling)

1. ММ только для сводных данных
Нет, это не так. По Кимбаллу нужна максимальная гранулярность. Сводные данные строятся на детальных, но не заменяют их

2. ММ для департаментов, не для всего бизнеса
По Кимбаллу строить хранилище данных стоит вокруг бизнес-сущностей (заказы и тд), а не департаментов. ММ как раз стирает границы между департаментами.

3. ММ не масштабируемо
Наоборот экстремально масштабируемы. Таблицы фактов могут иметь миллиарды, триллионы строк.

4. ММ только для предсказуемых запросов
При разработке таблиц измерений надо ориентироваться не на имеющиеся запросы (которые могут изменяться), а на существующие измерения бизнес-событий. Таблицы фактов должны иметь максимально возможную гранулярность. И таблицы измерений должны следовать этой гранулярности. Тогда подход будет выигрышным в далёкой перспективе. Подстраиваясь же под существующие аналитические запросы, которые как правило, что-то да агрегируют, вы решаете запрос здесь и сейчас, но рискуете получить проблемы в будущем. "Бог в деталях".

5. ММ не могут быть интегрированы
Да, это определенная организационная работа - согласовать измерения, достичь консенсуса. Но без этого усилия любое моделирование тщетно - и нормализованное, и нет. Без организационного консенсуса всё превращается в отдельно созданные витрины, и это не ответственность ММ.

### Больше причин to think dimensionally

Концепции многомерного моделирования уходят за пределы простых и быстрых структур.

Следует фокусироваться не на отдельных отчётах, запрашиваемых коллегами, а на бизнес-процессах как таковых. Следует приоритезировать области  процессы. Начинать можно с ключевых измерений. Крепкие измерения —> крепкое хранилище.

Концепции многомерного моделирования соединяют бизнес и техническое сообщества
